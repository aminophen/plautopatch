%
% plautopatch.sty
% written by Hironobu Yamashita (@aminophen)
%
% This package is part of the plautopatch bundle.
% https://github.com/aminophen/plautopatch
%

\NeedsTeXFormat{pLaTeX2e}
\ProvidesPackage{plautopatch}
    [2018/08/18 v0.1a Automated patches for pLaTeX/upLaTeX]
\def\pxgtmb@pkgname{plautopatch}

\RequirePackage{filehook}

% helpers

%% \platpc@patch@after{<orig>}{<patch>}
% = Load <patch> after <orig>.
\def\platpc@patch@after#1#2{%
  \AtEndOfPackageFile{#1}{\RequirePackage{#2}}%
}
%% \platpc@patch@after@both{<orig 1>}{<orig 2>}{<patch>}
% = Load <patch> after both <orig 1 & 2>.
\def\platpc@patch@after@both#1#2#3{%
  \AtEndOfPackageFile{#1}{\@ifpackageloaded{#2}{\RequirePackage{#3}}{}}%
  \AtEndOfPackageFile{#2}{\@ifpackageloaded{#1}{\RequirePackage{#3}}{}}%
}

%% \platpc@patch@before{<orig>}{<patch>}
% = Load <patch> before <orig>.
%   used when both conditions are met:
%   - <patch> must be loaded *before* <orig>
%   - <patch> contains \RequirePackage{<orig>}
\def\platpc@patch@before#1#2{%
  \expandafter\def\csname platpc@begin@#1\endcsname{%
    % the code (*!) should be used only once,
    % remove it immediately when this macro is executed
    \expandafter\let\csname platpc@begin@#1\endcsname\relax
    % pretend as if <orig> not loaded
    \expandafter\let\csname ver@#1.sty\endcsname\relax
    % load the <patch> package
    \RequirePackage{#2}%
    % avoid loading <orig> twice by discarding "\@@input <orig>" (*!)
    \let\platpc@filehook@@atbegin\filehook@@atbegin
    \def\filehook@@atbegin\@@input####1\filehook@atend{%
      \let\filehook@@atbegin\platpc@filehook@@atbegin
      % avoid infinite loop even when \AtEndOfPackageFile used
      \expandafter\let\csname filehook@atend@#1.sty\endcsname\relax
      \filehook@@atbegin
      \filehook@atend}%
    % all done
  }%
  \AtBeginOfPackageFile{#1}{\csname platpc@begin@#1\endcsname}%
}

% register patches

\platpc@patch@after{array}{plarray}% platex-tools
\platpc@patch@after@both{array}{plext}{plextarray}% platex-tools
\platpc@patch@after@both{delarray}{plext}{plextdelarray}% platex-tools
\platpc@patch@after{everysel}{pxeverysel}% platex-tools
\platpc@patch@after{everyshi}{pxeveryshi}% platex-tools
\platpc@patch@after{atbegshi}{pxatbegshi}% platex-tools
\platpc@patch@before{ftnright}{pxftnright}% platex-tools

\endinput
